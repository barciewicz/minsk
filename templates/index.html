<!DOCTYPE HTML>
    <html>
        <head>
<!--
            <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
-->
            <style>
                body {
                    background: rgb(100, 100, 100);
                    //font-family: Oswald;
                }
                
                #logo {
                   // letter-spacing: 1px;
                }
                
                #end_status {
					color: red;
				}
                td {
                    border: 1px solid black;
                    width: 15px;
                    height: 15px;
                    text-align: center;
                } 
                
                .silver_text {
                    color: silver;
                }
                
                .grey {
                    background: grey;
                }
                
                #board {
                    background: rgb(175, 175, 175);
                    font-size: 10px;
                }
                
                #board_container {
                    display: flex;
                    justify-content: center;
                }
            </style>
        </head>
        <body>
            <p id="logo">
                Min<span class="silver_text">Sk</span><br>
                minesweeper in <span class="silver_text">Flask</span>
            </p>
            <button id="new_game_button">New game</button>
            <div id="end_status"></div>
            <div id="board_container">
                <table id="board"></table>
            </div>
            <ul id="current_games_list"></ul>
        </body>
        <script>
               
        class Model {
            constructor() {
                this.game_id = ''
            }
               
             async startNewGame() {
                const url = "{{url_for('start_new_game')}}"
                console.log(url)
                const response = await fetch(url)
                const json = await response.json()
                
                this.game_id = json.game_id
                this.onGameDataReceived(json)
                //this.onGamesListReceived(json.current_games_ids)
                
                return json
            }
            
            async getGamesState(game_id) {
                const url = new URL("{{url_for('get_games_state', _external=True)}}")
                const params = new URLSearchParams({'game_id': game_id})
                url.search = params
                const response = await fetch(url)
                const json = await response.json()
                
                this.game_id = game_id
                this.onGameDataReceived(json)
                this.onGamesListReceived(json.current_games)

                return json
            }
            
            async revealCellArea(row, col) {
                //~ const url = new URL('http://192.168.1.14:5010/reveal_cell_area')
                const url = new URL("{{url_for('reveal_cell_area', _external=True)}}")
                const params = new URLSearchParams({
                    'row': row,
                    'col': col,
                    'game_id': this.game_id,
                })
                url.search = params
                const response = await fetch(url)
                const json = await response.json()
                this.onGameDataReceived(json)
                return json
            }
            
            async toggleFlag(row, col) {
                //~ const url = new URL('http://192.168.1.14:5010/toggle_flag')
                const url = new URL("{{url_for('toggle_flag', _external=True)}}")
                const params = new URLSearchParams({
                    'row': row,
                    'col': col,
                    'game_id': this.game_id,
                })
                url.search = params
                const response = await fetch(url)
                const json = await response.json()
                this.onGameDataReceived(json)
                return json
            }
            
            bindGameDataReceived(callback) {
                this.onGameDataReceived = callback
            }
            
            bindGamesListReceived(callback) {
                this.onGamesListReceived = callback
            }
        }
        
        class View {
            constructor() {
                this.board = document.getElementById('board')
                this.new_game_button = document.getElementById('new_game_button')
                this.current_games_list = document.getElementById('current_games_list')
                this.end_status = document.getElementById('end_status')
            }
            
            drawBoard(board, cell_click_handler) {
                let n_rows = board.n_rows
                let n_cols = board.n_cols
                let cells = board.cells
                let rows = board.rows
                console.log('drawing board', board)
                
                this.board.innerHTML = ''
                
                rows.forEach(row => {
                    let tr = document.createElement('tr')
                    row.forEach(cell => {
                        let td = document.createElement('td')
                        td.textContent = cell.symbol
                        if (cell.hidden) {
                            td.classList.add('grey')
                        }
                        td.id = cell.col
                        tr.appendChild(td)
                    })
                    this.board.appendChild(tr)
                })
            }
            
            refreshGamesList(current_games_ids) {
                
                this.current_games_list.innerHTML = ''
                
                current_games_ids.forEach(game_id => {
                    let li = document.createElement('li')
                    li.textContent = game_id
                    this.current_games_list.appendChild(li)
                })
            }
            
            bindGamesListItemClicked(handler) {
                this.current_games_list.addEventListener('click', e => {
                    let game_id = e.target.textContent
                    handler(game_id)
                })
            }
            
            bindNewGameClick(handler) {
                this.new_game_button.addEventListener('click', e => {
					this.end_status.textContent = ''
                    handler()
                })
            }
            
            bindBoardClick(handler) {
                this.board.addEventListener('click', e => {
                    let row = e.target.parentElement.rowIndex
                    let col = e.target.id
                    handler(row, col)
                })
            }
            
            bindBoardContextMenu(handler) {
                this.board.addEventListener('contextmenu', e => {
                    e.preventDefault()
                    let row = e.target.parentElement.rowIndex
                    let col = e.target.id
                    handler(row, col)
                })
            }
        }
        
        class Controller {
            constructor(model, view) {
                this.model = model
                this.view = view
                
                this.model.bindGameDataReceived(this.handleGameDataReceived)
                this.model.bindGamesListReceived(this.handleGamesListReceived)
                this.view.bindNewGameClick(this.handleNewGameClick)
                this.view.bindBoardClick(this.handleBoardClick)
                this.view.bindBoardContextMenu(this.handleContextMenu)
                this.view.bindGamesListItemClicked(this.handleGamesListItemClicked)
                
                this.model.startNewGame()
                this.pollGamesState()
            }
            
            pollGamesState = () => {
                let interval = setInterval(() => {
                    console.log('polling')
                    this.model.getGamesState(this.model.game_id)
                }, 1000)
            }
            
            handleGameDataReceived = game_data => {
				if (game_data.end_status) {
					this.view.end_status.textContent = game_data.end_status
				}
                //~ this.view.refreshGamesList(game_data.current_games_ids)
                if (game_data.board) {
					this.view.drawBoard(game_data.board)
				}
            }      
            
            handleGamesListReceived = current_games_ids => {
				console.log('current games:', current_games_ids)
                this.view.refreshGamesList(current_games_ids)
            }
            
            handleGamesListItemClicked = game_id => {
                this.model.getGamesState(game_id)
            }
            
            handleNewGameClick = () => {
                this.model.startNewGame()
            }
            
            handleBoardClick = (row, col) => {
                this.revealCellArea(row, col)
            }
            
            handleContextMenu = async (row, col) => {
                this.toggleFlag(row, col)
            }
            
            revealCellArea = async (row, col) => {
                let board = await this.model.revealCellArea(row, col)
            }
            
            async toggleFlag(row, col) {
                let board = await this.model.toggleFlag(row, col)
            }
        }
        
        let app = new Controller(new Model(), new View())
        </script>
    </html>
